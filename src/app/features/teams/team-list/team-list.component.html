<mat-card class="team-list-card">
  <div class="card-header">
    <span>Teams</span>
  </div>

  <!-- ✅ Loading bar at top -->
  @if (loading()) {
  <mat-progress-bar mode="indeterminate" color="accent" class="loading-bar">
  </mat-progress-bar>
  }

  <div class="teams-scroll">
    <mat-accordion multi>
      @for (team of teams; track team._id) {
      <mat-expansion-panel
        [expanded]="panelOpenState[team._id!]"
        (opened)="panelOpenState[team._id!] = true; onSelect(team)"
        (closed)="onClose(team)"
      >
        <mat-expansion-panel-header>
          <mat-panel-title>{{ team.teamName }}</mat-panel-title>
          <mat-panel-description>
            {{ team.members.length }} member{{
              team.members.length === 1 ? "" : "s"
            }}
          </mat-panel-description>
        </mat-expansion-panel-header>

        <!-- Team Description -->
        @if (team.description) {
        <div class="team-description">
          <strong>Description:</strong> {{ team.description }}
        </div>
        }

        <!-- ✅ Team Members (Avatar Strip) -->
        <div class="team-members-strip">
          @if (team.members.length > 0) {
          <div class="avatars">
          <!-- ✅ Draggable + Reorderable Member Avatars -->
          <div
            class="avatars"
            cdkDropList
            [cdkDropListData]="team.members"
            (cdkDropListDropped)="onDropMember($event, team)"
          >
            @for (m of getDisplayedMembers(team); track trackMember($index, m))
            {
            <div
              class="avatar-tile"
              cdkDrag
              [matTooltip]="m.name + (m.title ? ' — ' + m.title : '')"
              matTooltipPosition="above"
            >
              <img
                [src]="m.avatarUrl || '/avatar.png'"
                [alt]="m.name"
                class="avatar-img"
              />
            </div>
            } @if (team.members.length > maxAvatars) {
            <div
              class="more-count"
              [matTooltip]="
                team.members.length - maxAvatars + ' more member(s)'
              "
            >
              +{{ team.members.length - maxAvatars }}
            </div>
            }
          </div>

          } @else {
          <div class="empty">No members on this team.</div>
          } @if (capacityNotice[team._id!]) {
          <span class="text-error capacity-msg capacity-fade"
            >Team size limited to {{ TEAM_CAPACITY }} members</span
          >
          }

          <span class="count">
            {{ team.members.length }}/{{ TEAM_CAPACITY }}
          </span>

          <button
            mat-icon-button
            class="add-member-btn"
            (click)="onAddMember(team)"
          >
            <mat-icon>person_add</mat-icon>
          </button>
        </div>
      </mat-expansion-panel>
      } @empty {
      <div class="empty">No teams found.</div>
      }
    </mat-accordion>
  </div>

  <div class="panel-footer">
    <span class="spacer"></span>
    @if (selectedTeam) {
    <button
      mat-icon-button
      class="delete-team-btn"
      (click)="deleteSelectedTeam()"
      matTooltip="Delete Selected Team"
      matTooltipPosition="above"
      aria-label="Delete selected team"
    >
      <mat-icon>delete</mat-icon>
    </button>
    }
    <button
      mat-icon-button
      class="add-team-btn"
      (click)="openAddTeamDialog()"
      matTooltip="Add Team"
      matTooltipPosition="above"
      aria-label="Add team"
    >
      <mat-icon>add</mat-icon>
    </button>
  </div>
</mat-card>
